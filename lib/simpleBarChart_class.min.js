class simple_BarChart{constructor(params_barChart){this.id=params_barChart.id;this.ctx=params_barChart.ctx;this.category_field=params_barChart.category_field;this.sub_category_field=params_barChart.sub_category_field;this.numerical_field=params_barChart.numerical_field;this.agg_fieldName=params_barChart.numerical_field_params.agg_fieldName;this.title_x_axis=params_barChart.title_x_axis;this.title_y_axis=params_barChart.title_y_axis;this.label_tooltip=params_barChart.label_tooltip;this.type=params_barChart.type;this.responsive=true;this.title=params_barChart.title[0];this.list_segments_selected=[];this.nb_categories=0;this.nb_sous_categories=0}createChart(params_barChart,data_to_transform){var data_filtred=this.prepare_data_p1(params_barChart,data_to_transform);this.prepare_data_p2(data_filtred,params_barChart);var chart_instance=this.init_chart(params_barChart);if(params_barChart.interactions_chart_options.hoverOptions===true){this.add_options_hover(chart_instance,params_barChart)}if(params_barChart.interactions_chart_options.selectionOptions===true){this.addListeners(params_barChart.ctx,chart_instance,params_barChart)}params_barChart.instanciator=this}prepare_data_p1(params_chart){var d1=new Date();var result_filter=[];sharedParams.list_of_axis.push(params_chart.category_field);if(params_chart.transformations.dataset===undefined){var data_chart=[...sharedParams.data_main];}else{var data_chart=[...params_chart.transformations.dataset]}function filterDataSource(data_source,filterList){filterList.map(f=>{if(f.operation==="include"){data_source=data_source.filter((item)=>f.values.indexOf(item[f.field])!==-1)}else if(f.operation==="exclude"){data_source=data_source.filter((item)=>f.values.indexOf(item[f.field])===-1)}else if(f.operation==="<"){var fieldName=f.field;var fieldValue=f.value;data_source=data_source.filter((item)=>item[fieldName]<fieldValue)}else if(f.operation===">"){var fieldName=f.field;var fieldValue=f.value;data_source=data_source.filter((item)=>item[fieldName]>fieldValue)}else if(f.operation==="<="){var fieldName=f.field;var fieldValue=f.value;data_source=data_source.filter((item)=>item[fieldName]<=fieldValue)}else if(f.operation===">="){var fieldName=f.field;var fieldValue=f.value;data_source=data_source.filter((item)=>item[fieldName]>=fieldValue)}else if(f.operation==="between"){var fieldName=f.field;var fieldValueMin=f.valueMin;var fieldValueMax=f.valueMax;data_source=data_source.filter((item)=>item[fieldName]>=fieldValueMin&&item[fieldName]<=fieldValueMax)}});return data_source}var filterList={};if(params_chart.transformations.crossfilter!==undefined&&Object.keys(params_chart.transformations.crossfilter).length>0){var filter_array={};Object.assign(filter_array,params_chart.transformations.crossfilter);var filter_array_transformed=Object.values(_.mapValues(params_chart.transformations.crossfilter,function(value,key){return{field:key,operation:"include",values:value}}));Object.assign(filterList,filter_array_transformed);params_chart.transformations.crossfilter={}}if(params_chart.transformations.filter!==undefined){filterList=Object.values(filterList);params_chart.transformations.filter.map(e=>filterList.push(e));filterList=filterList.filter(l=>l.field!=="");var data_chart=filterDataSource(data_chart,filterList)}else if(Object.keys(filterList).length>0){filterList=Object.values(filterList);filterList=filterList.filter(l=>l.field!=="");var data_chart=filterDataSource(data_chart,filterList)}if(params_chart.bin_params.bin===false){var dataset_ChartJS=[];var agg_name_lodash=params_chart.numerical_field_params.agg_type+"By";var agg_fieldName=params_chart.numerical_field_params.agg_type+"_"+params_chart.numerical_field_params.fieldName;params_chart.numerical_field_params.agg_fieldName=agg_fieldName;let groupedItem=_.groupBy(data_chart,record=>record[params_chart.category_field]);if(params_chart.numerical_field_params.agg_type==="count"){dataset_ChartJS=_.map(groupedItem,(group,key)=>{return{[params_chart.category_field]:group[0][params_chart.category_field],[agg_fieldName]:(group.length)}})}else{dataset_ChartJS=_.map(groupedItem,(group,key)=>{return{[params_chart.category_field]:group[0][params_chart.category_field],[agg_fieldName]:_[agg_name_lodash](group,params_chart.numerical_field_params.fieldName)}})}console.log("tps exec lodash: "+(new Date()-d1)/1000);dataset_ChartJS.sort(trier(params_chart.category_field,'asc'));dataset_ChartJS=round_values(dataset_ChartJS,agg_fieldName)}else if(params_chart.bin_params.bin===true){}function round_values(dataset_ChartJS,agg_fieldName){for(var d=0;d<dataset_ChartJS.length;d+=1){dataset_ChartJS[d][agg_fieldName]=Math.round(dataset_ChartJS[d][agg_fieldName]*100)/100};return dataset_ChartJS}return dataset_ChartJS}prepare_data_p2(data_input,params_barChart){params_barChart.nb_axis=1;if(params_barChart.list_of_axis.length===0){params_barChart.list_of_axis.push(this.category_field)}var categories=deduplicate_dict(data_input,this.category_field);categories.sort();var nb_categories=categories.length;params_barChart.nb_categories=categories.length;params_barChart.activ_categories_values=[];params_barChart.activ_categories_values.push(categories);params_barChart.data[0].labels.push(categories);var nb_categories=params_barChart.data[0].labels[0].length;var borderColorArray=[];var borderWidthArray=[];for(var i=0;i<nb_categories;i+=1){borderColorArray.push('rgba(230, 11, 11, 0)');borderWidthArray.push(1)}if(params_barChart.backgroundColorArray_source.length===0){var status_colors="empty";params_barChart.backgroundColorArray_source=generateColors(nb_categories,params_barChart.colorsConfig.scheme,params_barChart.colorsConfig.colorsOrder)}var data_array=[];var backgroundColorArray=[];for(var i=0;i<nb_categories;i+=1){data_array.push(data_input[i][params_barChart.numerical_field_params.agg_fieldName]);backgroundColorArray.push(params_barChart.backgroundColorArray_source[i])};if(params_barChart.prepare_data_type==="preserve backgroundColor"){backgroundColorArray=[];var array_labels=params_barChart.data[0].labels[0];var active_category_fields=[];for(var c=0;c<params_barChart.active_slices.length;c+=1){active_category_fields.push(params_barChart.active_slices[c].category_field)}for(var a=0;a<params_barChart.active_slices.length;a+=1){var active_category_field=params_barChart.active_slices[a].category_field;var pos_active_category_field=array_labels.indexOf(active_category_field);for(var i=0;i<array_labels.length;i+=1){pos_active_category_field=active_category_fields.indexOf(array_labels[i]);if(pos_active_category_field===-1){backgroundColorArray.push('rgba(240, 240, 240, 0.5)')}else{var active_slice_backgroundColor=params_barChart.active_slices[pos_active_category_field].backgroundColor;backgroundColorArray.push(active_slice_backgroundColor)}}}}params_barChart.data[1].datasets.push({label:this.label_tooltip,backgroundColor:backgroundColorArray,borderWidth:borderWidthArray,borderColor:borderColorArray,data:data_array});params_barChart.list_idx_segments_existants=[];var list_idx_segments_existants=params_barChart.list_idx_segments_existants;for(var i=0;i<(nb_categories);i+=1){list_idx_segments_existants.push(i)}if(params_barChart.data_source_raw.length===0){params_barChart.data_source_raw=data_input;params_barChart.data_source[0].labels.push(categories);params_barChart.data_source[1].datasets=params_barChart.data[1].datasets}}init_chart(params_barChart){var barChart=new Chart(this.ctx,{type:this.type,data:[],options:{responsive:this.responsive,title:this.title,scales:{yAxes:[{ticks:{beginAtZero:true},scaleLabel:{display:true,labelString:this.title_y_axis}}],xAxes:[{scaleLabel:{display:true,labelString:this.title_x_axis}}]},animation:{duration:1000,easing:'easeOutQuad'},legend:{display:false}}});var data_type="data";var injection_type="init";this.inject_metadata(barChart,params_barChart,data_type,injection_type);return barChart}selections_listeners(params_barChart){}inject_metadata(barChart,params_barChart,data_type,injection_type){if(barChart.config.data.labels.length===0){barChart.config.data.labels=[...params_barChart[data_type][0].labels[0]]}if(injection_type==="init"){var l=params_barChart[data_type][1].datasets.length;var datasets=[];for(var i=0;i<l;i+=1){datasets.push(params_barChart[data_type][1].datasets[i]);barChart.config.data.datasets[i]=_.cloneDeep(datasets[i])}barChart.config.data.datasets=_.cloneDeep(datasets)}else if(injection_type==="update"){var l=params_barChart[data_type][1].datasets.length;var datasets=[];for(var i=0;i<l;i+=1){datasets.push(params_barChart[data_type][1].datasets[i]);barChart.config.data.datasets[i].data=_.cloneDeep(datasets[i].data);barChart.config.data.datasets[i].label=_.cloneDeep(datasets[i].label);barChart.config.data.datasets[i].backgroundColor=_.cloneDeep(datasets[i].backgroundColor);barChart.config.data.datasets[i].borderColor=_.cloneDeep(datasets[i].borderColor);barChart.config.data.datasets[i].borderWidth=_.cloneDeep(datasets[i].borderWidth)}}barChart.update(500);params_barChart.chart_instance=barChart;return barChart}maj_couleurs(barChart,params_barChart){var nb_categories=params_barChart.nb_categories;var backgroundColorArray=[];for(var i=0;i<nb_categories;i+=1){var backgroundColor=params_barChart.data_source[1].datasets[0].backgroundColor[i];barChart.config.data.datasets[0].backgroundColor[i]=backgroundColor}barChart.update()}reset_border_color(this_chart,params_barChart_deepCopy){var nb_categories=params_barChart_deepCopy.nb_categories;for(var i=0;i<nb_categories;i+=1){this_chart.config.data.datasets[0].borderColor[i]="rgba(230, 11, 11, 0)"}this_chart.update()}add_options_hover(this_chart,params_barChart_deepCopy){var activePoints;this_chart.config.options.hover={onHover:function(e){var point=this_chart.getElementAtEvent(e);if(point.length){e.target.style.cursor='pointer';this_chart.update();activePoints=this_chart.getElementAtEvent(e);if(activePoints[0]){var idx=activePoints[0]['_index'];var datasetIdx=activePoints[0]['_datasetIndex'];var activePoint_backgroundColor=activePoints[0]._model.backgroundColor;activePoints[0]._model.borderColor="rgba(230, 11, 11, 1)";params_barChart_deepCopy.border_activated=true;activePoint_backgroundColor=activePoint_backgroundColor.replace("0.65","1");activePoints[0]._model.backgroundColor=activePoint_backgroundColor;var datasetLabel=activePoints[0]._model.datasetLabel;var label=activePoints[0]._model.label;}}else{e.target.style.cursor='default';if(params_barChart_deepCopy.border_activated===true){params_barChart_deepCopy.instanciator.reset_border_color(this_chart,params_barChart_deepCopy);params_barChart_deepCopy.border_activated=false}}}}}addListeners(ctx,this_chart,params_barChart_deepCopy){ctx.addEventListener("mouseover",function(evt){var activePoints=this_chart.getElementAtEvent(evt);if(activePoints[0]){try{var categorie=activePoints[0]._model.label;var sous_categorie=activePoints[0]._model.datasetLabel}catch{console.log("segment non detecté, clic à l'exterieur du graph")}}else{var nb_categories=params_barChart_deepCopy.nb_categories;for(var i=0;i<nb_categories;i+=1){this_chart.config.data.datasets[0].borderColor[i]="rgba(230, 11, 11, 0)"}this_chart.update()}});ctx.addEventListener("click",function(evt){var activePoints=this_chart.getElementAtEvent(evt);if(activePoints[0]){try{var idx=activePoints[0]['_index'];var datasetIdx=activePoints[0]['_datasetIndex'];var key_composite=datasetIdx+"-"+idx;var categorie=activePoints[0]._model.label;var sous_categorie=activePoints[0]._model.datasetLabel;if(evt.shiftKey===false){params_barChart_deepCopy.list_idx_segments_multiples_selected=[];params_barChart_deepCopy.list_labels_segments_multiples_selected=[];params_barChart_deepCopy.list_keys_values_segments_multiples_selected=[]};params_barChart_deepCopy.list_labels_segment_single_selected=[];params_barChart_deepCopy.list_keys_values_segment_single_selected=[];var category_field=params_barChart_deepCopy.category_field;params_barChart_deepCopy.list_labels_segment_single_selected.push({category_field:categorie});params_barChart_deepCopy.list_keys_values_segment_single_selected.push({[category_field]:[categorie]});if(evt.shiftKey===false){params_barChart_deepCopy.list_labels_segments_multiples_selected.push({category_field:categorie});params_barChart_deepCopy.list_keys_values_segments_multiples_selected.push({[category_field]:[categorie]})}console.log("labels collectés:");console.log(params_barChart_deepCopy.list_labels_segment_single_selected);}catch{console.log("segment non detecté, clic à l'exterieur du graph")params_barChart_deepCopy.list_idx_segment_single_selected=[];params_barChart_deepCopy.list_labels_segment_single_selected=[];params_barChart_deepCopy.list_keys_values_segment_single_selected=[];params_barChart_deepCopy.list_keys_values_segment_single_selected=[];params_barChart_deepCopy.list_keys_values_segments_multiples_selected=[];params_barChart_deepCopy.active_slices=[]}}});ctx.onclick=function(evt){var activePoints=this_chart.getElementAtEvent(evt);if(activePoints[0]){params_barChart_deepCopy.instanciator.maj_couleurs(this_chart,params_barChart_deepCopy);var idx=activePoints[0]['_index'];var activePoint_backgroundColor=activePoints[0]._model.backgroundColor;activePoint_backgroundColor=activePoint_backgroundColor.replace("0.65","1");params_barChart_deepCopy.list_idx_segment_single_selected=[];params_barChart_deepCopy.list_idx_segment_single_selected.push(idx);if(evt.shiftKey===false){params_barChart_deepCopy.list_idx_segments_multiples_selected.push(idx);params_barChart_deepCopy.active_slices=[];params_barChart_deepCopy.active_slices.push({category_field:activePoints[0]._model.label,backgroundColor:activePoint_backgroundColor,index:idx})}var chartData=activePoints[0]['_chart'].config.data;var nb_categories=params_barChart_deepCopy.nb_categories;for(var i=0;i<(nb_categories);i+=1){if(idx!==i){this_chart.config.data.datasets[0].backgroundColor[i]="rgba(240, 240, 240, 0.5)"}else{activePoints[0]._model.backgroundColor=activePoint_backgroundColor;this_chart.config.data.datasets[0].backgroundColor[i]=activePoint_backgroundColor}}var backgroundColor_array=[];for(var i=0;i<this_chart.config.data.datasets.length;i+=1){backgroundColor_array.push(this_chart.config.data.datasets[i].backgroundColor)};params_barChart_deepCopy.backgroundColor_array_ClickedState=backgroundColor_array;this_chart.update()}else{params_barChart_deepCopy.prepare_data_type="";params_barChart_deepCopy.instanciator.maj_couleurs(this_chart,params_barChart_deepCopy);params_barChart_deepCopy.list_idx_segments_multiples_selected=[];params_barChart_deepCopy.list_labels_segments_multiples_selected=[];params_barChart_deepCopy.list_idx_segment_single_selected=[];params_barChart_deepCopy.list_labels_segment_single_selected=[];params_barChart_deepCopy.list_keys_values_segment_single_selected=[];params_barChart_deepCopy.list_keys_values_segments_multiples_selected=[];params_barChart_deepCopy.active_slices=[]}};ctx.ondblclick=function(evt){params_barChart_deepCopy.prepare_data_type="";params_barChart_deepCopy.instanciator.maj_couleurs(this_chart,params_barChart_deepCopy);params_barChart_deepCopy.list_idx_segments_multiples_selected=[];params_barChart_deepCopy.list_labels_segments_multiples_selected=[];params_barChart_deepCopy.list_idx_segment_single_selected=[];params_barChart_deepCopy.list_labels_segment_single_selected=[];params_barChart_deepCopy.list_keys_values_segment_single_selected=[];params_barChart_deepCopy.list_keys_values_segments_multiples_selected=[];params_barChart_deepCopy.active_slices=[]};ctx.addEventListener("click",function(e){if(e.shiftKey){console.log("Shift, yay!");params_barChart_deepCopy.instanciator.maj_couleurs(this_chart,params_barChart_deepCopy);var activePoints=this_chart.getElementAtEvent(e);var idx=activePoints[0]['_index'];var categorie=activePoints[0]._model.label;var category_field=params_barChart_deepCopy.category_field;var activePoint_backgroundColor=activePoints[0]._model.backgroundColor;activePoint_backgroundColor=activePoint_backgroundColor.replace("0.65","1");var list_idx_segments_existants=params_barChart_deepCopy.list_idx_segments_existants;params_barChart_deepCopy.list_idx_segment_single_selected=[];params_barChart_deepCopy.list_labels_segment_single_selected=[];var pos_slice=params_barChart_deepCopy.list_idx_segments_multiples_selected.indexOf(idx);if(pos_slice===-1){params_barChart_deepCopy.list_idx_segments_multiples_selected.push(idx);params_barChart_deepCopy.list_labels_segments_multiples_selected.push({"category_field":categorie});params_barChart_deepCopy.list_keys_values_segments_multiples_selected.push({[category_field]:[categorie]});params_barChart_deepCopy.active_slices.push({category_field:categorie,backgroundColor:activePoint_backgroundColor,index:idx})}else{params_barChart_deepCopy.list_idx_segments_multiples_selected.splice(pos_slice,1);var index_cat=params_barChart_deepCopy.list_labels_segments_multiples_selected.findIndex(x=>x.category_field===categorie);params_barChart_deepCopy.list_labels_segments_multiples_selected.splice(index_cat,1);var index_cat=params_barChart_deepCopy.list_keys_values_segments_multiples_selected.findIndex(x=>x[category_field][0]===categorie);params_barChart_deepCopy.list_keys_values_segments_multiples_selected.splice(index_cat,1);var index_cat=params_barChart_deepCopy.active_slices.findIndex(x=>x.category_field===categorie);params_barChart_deepCopy.active_slices.splice(index_cat,1)}var chartData=activePoints[0]['_chart'].config.data;var nb_segments_existants=params_barChart_deepCopy.list_idx_segments_existants.length;var nb_categories=params_barChart_deepCopy.nb_categories;var nb_segments_existants=this_chart.data.labels.length;var activ_idx_values=params_barChart_deepCopy.active_slices.map(o=>o.index);for(var i=0;i<(nb_segments_existants);i+=1){var segment_courant=i;if(activ_idx_values.indexOf(i)===-1){this_chart.data.datasets[0].backgroundColor[i]="rgba(240, 240, 240, 0.5)"}else{var bckg_color_activSlice=params_barChart_deepCopy.active_slices.filter(o=>o.index===i)[0].backgroundColor;this_chart.data.datasets[0].backgroundColor[i]=bckg_color_activSlice}}this_chart.update()}},false)}}